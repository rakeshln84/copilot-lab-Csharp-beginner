# Step 4: Add Unit Tests to MusicStoreService

In this step, you will refactor the `MusicStoreService` class and add unit tests to verify its CRUD operations.

1.  **Refactor to Repository Pattern**

    First, let's refactor the `MusicStoreService` class to use a repository pattern. This will help separate data access logic from service logic and make it easier to mock data for testing.

    **Create MusicStoreRepository**

    Add a new file `MusicStoreRepository.cs` to the project and define the `MusicStoreRepository` class as shown below. The sample data is read from a JSON file `albums.json` and stored in the `Albums` property.

    ```csharp
    public class MusicStoreRepository
    {
        public virtual List<Album> Albums { get; set; }

        public MusicStoreRepository()
        {
            // Read all albums from a JSON file
            var file = System.IO.File.ReadAllText("albums.json");
            Albums = Newtonsoft.Json.JsonConvert.DeserializeObject<List<Album>>(file);
        }
    }
    ```

    **Build the Project**

    From the terminal window, run the following command to build the project:

    ```bash
    dotnet build
    ```

    You will encounter a compilation error indicating that the `Newtonsoft.Json` package is missing:

    ```text
    error CS0103: The name 'Newtonsoft' does not exist in the current context
    ```

    **Fix Missing Package**

    To resolve this, add the `Newtonsoft.Json` package to the project. Use the following command:

    ```bash
    dotnet add package Newtonsoft.Json
    ```

    **Add albums.json File**

    Create a new file `albums.json` in the project root directory. Update the project file `MusicStore.csproj` to include this file in the output directory:

    ```xml
    <ItemGroup>
        <Content Include="albums.json">
            <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        </Content>
    </ItemGroup>
    ```

    Add sample data to the `albums.json` file. Here is an example:

    ```json
    [
      {
        "Id": 1,
        "Title": "The Dark Side of the Moon",
        "Artist": "Pink Floyd",
        "ReleaseDate": "1973-03-01T00:00:00",
        "Genre": {
          "Id": 1,
          "Name": "Rock"
        }
      }
    ]
    ```

2.  **Update MusicStoreService**

    Now, update the `MusicStoreService` class to use the new `MusicStoreRepository` class. The `MusicStoreService` class should now have a dependency on the `MusicStoreRepository` class.

    The modified `MusicStoreService` class should look like this:

    ```csharp

    public class MusicStoreService
    {
    private readonly MusicStoreRepository _repository;

        public MusicStoreService(MusicStoreRepository repository)
        {
            _repository = repository;
        }

        public List<Album> GetAlbums()
        {
            return _repository.Albums;
        }

        public Album GetAlbum(int id)
        {
            return _repository.Albums.FirstOrDefault(a => a.Id == id);
        }

        public void AddAlbum(Album album)
        {
            if (!_repository.Albums.Any(a => a.Id == album.Id))
            {
                _repository.Albums.Add(album);
            }
            else
            {
                throw new DuplicateAlbumException("Album already exists.");
            }
        }

        public void UpdateAlbum(Album album)
        {
            var existingAlbum = _repository.Albums.FirstOrDefault(a => a.Id == album.Id);
            if (existingAlbum != null)
            {
                existingAlbum.Title = album.Title;
                existingAlbum.Artist = album.Artist;
                existingAlbum.ReleaseDate = album.ReleaseDate;
                existingAlbum.Genre = album.Genre;
            }
        }

        public void DeleteAlbum(int id)
        {
            var album = _repository.Albums.FirstOrDefault(a => a.Id == id);
            if (album != null)
            {
                _repository.Albums.Remove(album);
            }
        }

        public List<Album> SearchAlbumsByTitle(string title)
        {
            return _repository.Albums.Where(a => a.Title.Equals(title, StringComparison.OrdinalIgnoreCase)).ToList();
        }

        public List<Album> SearchAlbumsByArtist(string artist)
        {
            return _repository.Albums.Where(a => a.Artist.Equals(artist, StringComparison.OrdinalIgnoreCase)).ToList();
        }

        public List<Album> SearchAlbumsByGenre(string genre)
        {
            var genreId = _repository.Albums.FirstOrDefault(a => a.Genre.Name.Equals(genre, StringComparison.OrdinalIgnoreCase))?.Genre.Id;
            if (genreId != null)
                return _repository.Albums.Where(a => a.Genre.Id == genreId).ToList();
            return new List<Album>();
        }

    }
    ```

    Run the application to ensure that the code compiles successfully. Fix any compilation errors using `/fix` option in the Copilot chat.

    [Previous - Step 3: Refactor and Enhance Code Quality](./03-Step03.md)
