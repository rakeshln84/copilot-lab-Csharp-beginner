# Add Unit Tests

In this step, you will add unit tests to the MusicStoreService class to test the CRUD operations.

1. Before adding unit tests, let us refactor the MusicStoreService class to use a repository pattern. This will help in separating the data access logic from the service logic and also mock the data for testing.

   Add a new file `MusicStoreRepository.cs` to the project and define the MusicStoreRepository class as shown below:
   The sample data is read from a json file `albums.json` and stored in the Albums property.

   ```csharp

       public class MusicStoreRepository
       {
           public virtual List<Album> Albums { get; set; }

           public MusicStoreRepository()
           {
               //read all albums from a json file
               var file = System.IO.File.ReadAllText("albums.json");
               Albums = Newtonsoft.Json.JsonConvert.DeserializeObject<List<Album>>(file);
           }
       }

   ```

   From the terminal window, run the following command to build the project:

   ```bash
   dotnet build
   ```

   You will notice compilation error in the terminal window as -

   ```text
   error CS0103: The name
   'Newtonsoft' does not exist in the current context
   ```

   Let us fix this using Copilot. Use the slash command `/explain` and `@terminal` extension to ask Copilot to explain the error in the terminal. Copilot identifies the issues as missing reference to the `Newtonsoft.Json` package.

   Ask Copilot for the steps add the Newtonsoft.Json package to the project. You should see a response similar to the following:

```csharp

    public class MusicStoreService
 {
     private readonly MusicStoreRepository _repository;

     public MusicStoreService(MusicStoreRepository repository)
     {
         _repository = repository;
     }

     public List<Album> GetAlbums()
     {
         return _repository.Albums;
     }

     public Album GetAlbum(int id)
     {
         return _repository.Albums.FirstOrDefault(a => a.Id == id);
     }

     public void AddAlbum(Album album)
     {
         if (!_repository.Albums.Any(a => a.Id == album.Id))
         {
             _repository.Albums.Add(album);
         }
         else
         {
             throw new DuplicateAlbumException("Album already exists.");
         }
     }

     public void UpdateAlbum(Album album)
     {
         var existingAlbum = _repository.Albums.FirstOrDefault(a => a.Id == album.Id);
         if (existingAlbum != null)
         {
             existingAlbum.Title = album.Title;
             existingAlbum.Artist = album.Artist;
             existingAlbum.ReleaseDate = album.ReleaseDate;
             existingAlbum.Genre = album.Genre;
         }
     }

     public void DeleteAlbum(int id)
     {
         var album = _repository.Albums.FirstOrDefault(a => a.Id == id);
         if (album != null)
         {
             _repository.Albums.Remove(album);
         }
     }

     public List<Album> SearchAlbumsByTitle(string title)
     {
         return _repository.Albums.Where(a => a.Title.Equals(title, StringComparison.OrdinalIgnoreCase)).ToList();
     }

     public List<Album> SearchAlbumsByArtist(string artist)
     {
         return _repository.Albums.Where(a => a.Artist.Equals(artist, StringComparison.OrdinalIgnoreCase)).ToList();
     }

     public List<Album> SearchAlbumsByGenre(string genre)
     {
         var genreId = _repository.Albums.FirstOrDefault(a => a.Genre.Name.Equals(genre, StringComparison.OrdinalIgnoreCase))?.Genre.Id;
         if (genreId != null)
             return _repository.Albums.Where(a => a.Genre.Id == genreId).ToList();
         return new List<Album>();
     }
 }

```
